<!--
`<wine-search-facet-filter>` is Description

@element WineSearchFacetFilter
-->
<dom-module id="wine-search-facet-filter">
  <template>
    <style>
      :host {
        display: block
      }

      .filter {
        padding: 2px 5px;
      }
      .filter a {
        display: inline-block;
        cursor: pointer;
        color: black;
        transition: color 250ms ease-out, transform 250ms ease-out;
        transform: scale(1);
      }
      .filter a span {
        color: var(--default-primary-color);
      }
      .filter a:hover {
        transform: scale(1.5);
        color: var(--default-primary-color);
      }

      .active-filter {
        cursor: pointer;
        display: flex;
        align-items: center;
        color: white;
        font-size: 14px;
        background: var(--primary-text-color);
        padding: 5px;
        border-radius: 3px;
        margin: 3px;
      }

      .active-filter:hover {
        color: var(--default-primary-color);
        background: #ccc;
      }
    </style>

    <h2>[[label]]</h2>
    <div style="margin-bottom: 15px" hidden="[[!activeFilters.length]]">
      <template is="dom-repeat" items="[[activeFilters]]">
        <div>
          <div style="display:inline-block">
            <a class="active-filter" on-click="removeFilter" index$="[[index]]">
              <iron-icon icon="cancel"></iron-icon>
              <span>[[item]]</span>
            </a>
          </div>
        </div>
      </template>
    </div>
    <div>
      <template is="dom-repeat" items="[[buckets]]">
        <div class="filter">
          <a on-click="appendFilter" index$="[[index]]">[[item.key]] <span>([[item.doc_count]])</span></a>
        </div>
      </template>
    </div>

  </template>

  <script>
    class WineSearchFacetFilter extends AppSearchElement {

      static get is() { return 'wine-search-facet-filter'; }

      static get properties() {
        return {
          label : {
            type : String,
            value : ''
          },
          filter : {
            type : String,
            value : ''
          },
          buckets : {
            type : Array,
            value : []
          },
          activeFilters : {
            type : Array,
            value : []
          }
        };
      }

      onSearchUpdate(e) {
        if( e.state !== 'loaded' ) return;

        var query = e.body.query;
        var activeFilters = [];
        if( query && 
            query.bool && 
            query.bool.filter ) {
          
          var arr = query.bool.filter;

          for( var i = 0; i < arr.length; i++ ) {
            if( arr[i].terms[this.filter] ) {
              activeFilters = arr[i].terms[this.filter];
            }
          }
        }
        this.activeFilters = activeFilters;

        this.buckets = e
                        .response
                        .aggregations[this.filter]
                        .buckets
                        .filter((bucket) => {
                          if( this.activeFilters.indexOf(bucket.key) > -1 ) return false;
                          return true;
                        });
                        
        if( this.activeFilters.length === 0 &&
            this.buckets.length === 0 ) {
          this.style.display = 'none';
        } else {
          this.style.display = 'block';
        }
      }

      appendFilter(e) {
        var item = this.buckets[parseInt(e.currentTarget.getAttribute('index'))];
        this.ebEmit('append-search-filter', {
          key : this.filter,
          value : item.key,
          exec : true
        });
      }

      removeFilter(e) {
        var item = this.activeFilters[parseInt(e.currentTarget.getAttribute('index'))];
        this.ebEmit('remove-search-filter', {
          key : this.filter,
          value : item,
          exec : true
        });
      }


    }

    window.customElements.define(WineSearchFacetFilter.is, WineSearchFacetFilter);
  </script>
</dom-module>