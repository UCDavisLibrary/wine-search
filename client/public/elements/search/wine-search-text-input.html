<!--
`<wine-search-text-input>` is Description

@element wine-search-text-input
-->
<dom-module id="wine-search-text-input">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        position: relative;
      }
      
      [hidden] {
        display: none;
      }

      .suggestions {
        position: absolute;
        padding: 15px;
        background: white;
        left: 0;
        right: 0;
        z-index: 100;
      }

      .suggestions a {
        cursor: pointer;
        color: var(--default-primary-color);
        margin-right: 25px;
      }

      h3 {
        margin-top: 0;
        color: var(--secondary-text-color);
      }
    </style>

    <paper-input label="Search" on-keyup="_onKeyUp"  on-click="_cancelHide" on-focus="suggest" id="input"></paper-input>

    <paper-material class="suggestions" hidden$="[[!suggestions.length]]" on-click="_cancelHide">
      <h3>Suggestions</h3>
      <template is="dom-repeat" items="[[suggestions]]">
        <span><a on-click="_useSuggestion">[[item]]</a></span>
      </template>
    </paper-material>

  </template>

  <script>
    class WineSearchTextInput extends AppSearchElement {

      static get is() { return 'wine-search-text-input'; }

      static get properties() {
        return {
          suggestions : {
            type : Array,
            value : function() {
              return [];
            }
          }
        };
      }

      get ebBind() {
        return Object.assign(
          super.ebBind,
          {
            'suggest-request-update' : 'onSuggestUpdate'
          }
        )
      }

      get SUGGEST_KEY() {
        return 'name-suggest'
      }

      ready() {
        super.ready();

        window.addEventListener('click', () => {
          this.suggestions = [];
        });
      }

      _onKeyUp(e) {
        if( e.which === 13 ) this.search();
        else this.bufferSuggest();
      }

      search() {
        this.ebEmit('text-search', {
          text : this.$.input.value,
          options : {
            exec : true
          }
        });
        this.$.input.value;
      }

      _useSuggestion(e) {
        var text = e.currentTarget.innerHTML;
        var parts = this.$.input
          .value
          .split(' ')
          .filter(val => val.length ? true : false);

        parts[parts.length-1] = text;
        this.$.input.value = parts.join(' ');
        this.search();
      }

      bufferSuggest() {
        this._suggestDebouncer = Polymer.Debouncer.debounce(
          this._suggestDebouncer, // initially undefined
          Polymer.Async.timeOut.after(100),
          this.suggest.bind(this)
        );
      }

      suggest() {
        var parts = (this.$.input.value || '')
          .split(' ')
          .filter(val => val.length ? true : false);

        if( parts.length === 0 ) {
          this.suggestions = [];
          return;
        }

        var suggestOn = parts[parts.length-1];

        if( suggestOn.length < 1 ) {
          this.suggestions = [];
          return;
        }

        this.ebEmit('suggest-request', {
          text : suggestOn,
          exec : true
        });
      }

      _cancelHide(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      onSuggestUpdate(e) {
        if( e.state !== 'loaded' ) return;

        var resp = e.response;

        this.suggestions = [];

        if( !resp.suggest ) return;
        if( !resp.suggest[this.SUGGEST_KEY] ) return;
        if( !resp.suggest[this.SUGGEST_KEY][0] ) return;

        var currentValue = e.body.suggest[this.SUGGEST_KEY].prefix.toLowerCase();
        this.suggestions = resp
                            .suggest[this.SUGGEST_KEY][0]
                            .options
                            .map((item) => item.text)
                            .reduce((arr, val) => {
                              if( arr.indexOf(val) === -1 && 
                                  val.toLowerCase() !== currentValue ) {
                                arr.push(val);
                              } 
                              return arr;
                            }, []);
      }

      onSearchUpdate(e) {
        if( e.state !== 'loaded' ) return;
        this.suggestions = [];
      }

    }

    window.customElements.define(WineSearchTextInput.is, WineSearchTextInput);
  </script>
</dom-module>